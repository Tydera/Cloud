#cloud-config

# Cloud-init configuration for FinNaslain application servers

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - unattended-upgrades

write_files:
  - path: /etc/environment
    content: |
      ENVIRONMENT=${environment}
      DB_HOST=${db_host}
      DB_PORT=${db_port}
      DB_NAME=${db_name}
      DB_USER=${db_user}
    permissions: '0644'

  - path: /etc/systemd/system/finnaslaim-app.service
    content: |
      [Unit]
      Description=FinNaslain Application
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/finnaslaim
      EnvironmentFile=/etc/environment
      ExecStart=/usr/bin/docker-compose up -d
      ExecStop=/usr/bin/docker-compose down

      [Install]
      WantedBy=multi-user.target
    permissions: '0644'

  - path: /opt/finnaslaim/docker-compose.yml
    content: |
      version: '3.8'
      services:
        app:
          image: ${docker_image}
          restart: always
          ports:
            - "80:8080"
          environment:
            - NODE_ENV=${environment}
            - DB_HOST=${db_host}
            - DB_PORT=${db_port}
            - DB_NAME=${db_name}
            - DB_USER=${db_user}
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
          logging:
            driver: "json-file"
            options:
              max-size: "10m"
              max-file: "3"
    permissions: '0644'

runcmd:
  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Install Docker Compose standalone
  - curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose

  # Configure firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow http
  - ufw allow https
  - ufw --force enable

  # Configure fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Enable automatic security updates
  - echo 'Unattended-Upgrade::Automatic-Reboot "false";' >> /etc/apt/apt.conf.d/50unattended-upgrades
  - systemctl enable unattended-upgrades

  # Start application
  - systemctl daemon-reload
  - systemctl enable finnaslaim-app.service
  - systemctl start finnaslaim-app.service

final_message: "FinNaslain application server is ready!"
